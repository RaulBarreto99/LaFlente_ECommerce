<!DOCTYPE html>
<html lang="zxx" class="no-js">

<head>
<!-- Mobile Specific Meta -->
<meta name="viewport"
	content="width=device-width, initial-scale=1, shrink-to-fit=no">
<!-- Favicon-->
<link rel="shortcut icon" href="img/fav.png">
<!-- Author Meta -->
<meta name="author" content="CodePixar">
<!-- Meta Description -->
<meta name="description" content="">
<!-- Meta Keyword -->
<meta name="keywords" content="">
<!-- meta character set -->
<meta charset="UTF-8">
<!-- Site Title -->
<title>laFlente</title>

<!--
		CSS
		============================================= -->
<link rel="stylesheet" href="css/linearicons.css">
<link rel="stylesheet" href="css/owl.carousel.css">
<link rel="stylesheet" href="css/themify-icons.css">
<link rel="stylesheet" href="css/font-awesome.min.css">
<link rel="stylesheet" href="css/nice-select.css">
<link rel="stylesheet" href="css/nouislider.min.css">
<link rel="stylesheet" href="css/bootstrap.css">
<link rel="stylesheet" href="css/main.css">
</head>

<body onload="preencherCampos()">

	<!-- Start Header Area -->
	<header class="header_area sticky-header">
		<div class="main_menu">
			<nav class="navbar navbar-expand-lg navbar-light main_box">
				<div class="container">
					<!-- Brand and toggle get grouped for better mobile display -->
					<a class="navbar-brand logo_h" href="index.html"><img
						src="img/logo.png" alt=""></a>
					<button class="navbar-toggler" type="button" data-toggle="collapse"
						data-target="#navbarSupportedContent"
						aria-controls="navbarSupportedContent" aria-expanded="false"
						aria-label="Toggle navigation">
						<span class="icon-bar"></span> <span class="icon-bar"></span> <span
							class="icon-bar"></span>
					</button>
					<!-- Collect the nav links, forms, and other content for toggling -->
					<div class="collapse navbar-collapse offset"
						id="navbarSupportedContent">
						<ul class="nav navbar-nav menu_nav ml-auto">
							<li class="nav-item"><a class="nav-link" href="/">Home</a></li>
							<li class="nav-item submenu dropdown active"><a href="#"
								class="nav-link dropdown-toggle" data-toggle="dropdown"
								role="button" aria-haspopup="true" aria-expanded="false">Produtos</a>
								<ul class="dropdown-menu">
									<li class="nav-item"><a class="nav-link" href="/produto">Produtos</a></li>
								</ul></li>

							<li class="nav-item submenu dropdown"><a href="#"
								class="nav-link dropdown-toggle" data-toggle="dropdown"
								role="button" aria-haspopup="true" aria-expanded="false">Login</a>
								<ul class="dropdown-menu">
									<li class="nav-item"><a class="nav-link" href="/login">Login</a></li>

								</ul></li>
							<li class="nav-item"><a class="nav-link" href="/contato">Contato</a></li>
						</ul>
						<ul class="nav navbar-nav navbar-right">
							<li class="nav-item"><a href="#" class="cart"><span
									class="ti-bag"></span></a></li>
							<li class="nav-item">
								<button class="search">
									<span class="lnr lnr-magnifier" id="search"></span>
								</button>
							</li>
						</ul>
					</div>
				</div>
			</nav>
		</div>
		<div class="search_input" id="search_input_box">
			<div class="container">
				<form class="d-flex justify-content-between">
					<input type="text" class="form-control" id="search_input"
						placeholder="Search Here">
					<button type="submit" class="btn"></button>
					<span class="lnr lnr-cross" id="close_search" title="Close Search"></span>
				</form>
			</div>
		</div>
	</header>
	<!-- End Header Area -->

	<!-- Start Banner Area -->
	<section class="banner-area organic-breadcrumb">
		<div class="container">
			<div
				class="breadcrumb-banner d-flex flex-wrap align-items-center justify-content-end">
				<div class="col-first">
					<h1>Editar Conta</h1>
					<nav class="d-flex align-items-center"></nav>
				</div>
			</div>
		</div>
	</section>
	<!-- End Banner Area -->

	<!--================Checkout Area =================-->
	<section class="checkout_area section_gap">
		<div class="container" align="center">
			<div class="col-lg-8" align="center">
				<h3>Dados Pessoais</h3>
				<hr>
				<div id="erros"></div>
				<form class="row contact_form" novalidate="novalidate">
					<div class="col-md-12 form-group p_star">
						<input type="text" class="form-control" id="nome" name="name" placeholder="Nome Completo*">
					</div>

					<div class="col-md-6 form-group p_star">
						<input type="text" class="form-control" id="telefone" name="number" placeholder="Telefone">
					</div>
					<div class="col-md-6 form-group p_star">
						<input type="text" class="form-control" id="cpf" name="number" placeholder="CPF*" disabled>
					</div>
					<div class="col-md-12 form-group p_star">
						<input type="email" class="form-control" id="email"
							name="compemailany" placeholder="Email*" disabled>
					</div>

					<div class="col-md-6 form-group p_star">
						<input type="password" class="form-control" id="senha"
							name="compemailany" placeholder="Senha*">
					</div>
					
					<div class="col-md-6 form-group p_star">
						<input type="password" class="form-control" id="confirmarSenha"
							 placeholder="Confirmar Senha*">
					</div>

				</form>
				<br>

				<h3>Endereços de Entrega</h3>
				<p id="texto" style="color: red;"></p>
				<hr>
				<form class="row contact_form">
					
					<br>
					<div class="col-md-3 form-group p_star">
						<input type="text" class="form-control" id="cep" name="number" placeholder="CEP*">
					</div>
					<div class="col-md-3 form-group p_star">
						<button class="click-btn btn btn-default" onclick="buscarCep()"><i class="fa fa-search" aria-hidden="true"></i></button>
					</div>
					<div class="col-md-12 form-group p_star">
						<input type="text" class="form-control" id="logradouro" name="logradouro" placeholder="Logradouro*">
					</div>
					<div class="col-md-12 form-group p_star">
						<input type="text" class="form-control" id="complemento" name="complemento" placeholder="Complemento">
					</div>
					<div class="col-md-12 form-group p_star">
						<input type="text" class="form-control" id="bairro" name="bairro" placeholder="Bairro*">
					</div>
					<div class="col-md-12 form-group p_star">
						<input type="text" class="form-control" id="cidade" name="cidade" placeholder="Cidade*">
					</div>
					<div class="col-md-2 form-group">
						<input type="text" class="form-control" id="uf" name="uf"
							placeholder="UF*">
					</div>
					<div class="col-md-2 form-group">
						<input type="text" class="form-control" id="numero" name="numero"
							placeholder="Número*">
					</div>
					<div class="col-md-3 form-group">
						<input type="checkbox" class="form-check-input" id="enderecoFiscal">
    					<label class="form-check-label" for="enderecoFiscal">Endereço Fiscal</label>
					</div>
					<div class="col-md-12 form-group p_star">
					
						<div class="add-bag d-flex align-items-center" style="float: right;">
							<button class="add-btn" id="salvarEndereco" onclick="addEndereco()" style="cursor: pointer"><span class="lnr lnr-cross"></span></button>
							<span class="add-text text-uppercase" for="salvarEndereco">Adicionar Endereço</span>
						</div>
					</div>
				</form>
			</div>
			<br>
			<br>
			<br>
			<h3>Endereços Salvos</h3>
			<br>
			<table class="table">
					<thead>
						<th> CEP </th>
						<th> Logradouro </th>
						<th> Complemento </th>
						<th> Bairro </th>
						<th> Cidade </th>
						<th> UF </th>
						<th> Nº </th>
						<th> Fiscal? </th>
						<th> Remover </th>
					</thead>
					
					<tbody id="tabela">
					
					</tbody>
				</table>
				<br>
			<br>
			<br>
				<div class="col-md-12 form-group">
					<button type="button" onclick="editarUsuario()" class="primary-btn">Salvar Perfil</button>
				</div>
		</div>
	</section>
	<!--================End Checkout Area =================-->

	<!-- start footer Area -->
	<footer class="footer-area section_gap">
		<div class="container">
			<div class="row">
				<div class="col-lg-3  col-md-6 col-sm-6">
					<div class="single-footer-widget">
						<h6>About Us</h6>
						<p>Lorem ipsum dolor sit amet, consectetur adipisicing elit,
							sed do eiusmod tempor incididunt ut labore dolore magna aliqua.</p>
					</div>
				</div>
				<div class="col-lg-4  col-md-6 col-sm-6">
					<div class="single-footer-widget">
						<h6>Newsletter</h6>
						<p>Stay update with our latest</p>
						<div class="" id="mc_embed_signup">

							<form target="_blank" novalidate="true"
								action="https://spondonit.us12.list-manage.com/subscribe/post?u=1462626880ade1ac87bd9c93a&amp;id=92a4423d01"
								method="get" class="form-inline">

								<div class="d-flex flex-row">

									<input class="form-control" name="EMAIL"
										placeholder="Enter Email" onfocus="this.placeholder = ''"
										onblur="this.placeholder = 'Enter Email '" required=""
										type="email">


									<button class="click-btn btn btn-default">
										<i class="fa fa-long-arrow-right" aria-hidden="true"></i>
									</button>
									<div style="position: absolute; left: -5000px;">
										<input name="b_36c4fd991d266f23781ded980_aefe40901a"
											tabindex="-1" value="" type="text">
									</div>

									<!-- <div class="col-lg-4 col-md-4">
													<button class="bb-btn btn"><span class="lnr lnr-arrow-right"></span></button>
												</div>  -->
								</div>
								<div class="info"></div>
							</form>
						</div>
					</div>
				</div>
				<div class="col-lg-3  col-md-6 col-sm-6">
					<div class="single-footer-widget mail-chimp">
						<h6 class="mb-20">Instragram Feed</h6>
						<ul class="instafeed d-flex flex-wrap">
							<li><img src="img/i1.jpg" alt=""></li>
							<li><img src="img/i2.jpg" alt=""></li>
							<li><img src="img/i3.jpg" alt=""></li>
							<li><img src="img/i4.jpg" alt=""></li>
							<li><img src="img/i5.jpg" alt=""></li>
							<li><img src="img/i6.jpg" alt=""></li>
							<li><img src="img/i7.jpg" alt=""></li>
							<li><img src="img/i8.jpg" alt=""></li>
						</ul>
					</div>
				</div>
				<div class="col-lg-2 col-md-6 col-sm-6">
					<div class="single-footer-widget">
						<h6>Follow Us</h6>
						<p>Let us be social</p>
						<div class="footer-social d-flex align-items-center">
							<a href="#"><i class="fa fa-facebook"></i></a> <a href="#"><i
								class="fa fa-twitter"></i></a> <a href="#"><i
								class="fa fa-dribbble"></i></a> <a href="#"><i
								class="fa fa-behance"></i></a>
						</div>
					</div>
				</div>
			</div>
			<div
				class="footer-bottom d-flex justify-content-center align-items-center flex-wrap">
				<p class="footer-text m-0">
					<!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
					Copyright &copy;
					<script>
						document.write(new Date().getFullYear());
					</script>
					All rights reserved | This template is made with <i
						class="fa fa-heart-o" aria-hidden="true"></i> by <a
						href="https://colorlib.com" target="_blank">Colorlib</a>
					<!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
				</p>
			</div>
		</div>
	</footer>
	<!-- End footer Area -->


	<script src="js/vendor/jquery-2.2.4.min.js"></script>
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"
		integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4"
		crossorigin="anonymous"></script>
	<script src="js/vendor/bootstrap.min.js"></script>
	<script src="js/jquery.ajaxchimp.min.js"></script>
	<script src="js/jquery.nice-select.min.js"></script>
	<script src="js/jquery.sticky.js"></script>
	<script src="js/nouislider.min.js"></script>
	<script src="js/jquery.magnific-popup.min.js"></script>
	<script src="js/owl.carousel.min.js"></script>
	<!--gmaps Js-->
	<script
		src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCjCGmQ0Uq4exrzdcL6rvxywDDOvfAu6eE"></script>
	<script src="js/gmaps.min.js"></script>
	<script src="js/main.js"></script>
</body>

<script>

	let enderecos = [];
	let enderecosInseridos = [];
	let enderecosFormatados = [];
	let i = 0;
	let idUsuario = 0;
	let enderecosRemovidos = [];
	
	let inputNome = document.getElementById("nome");
	let inputCpf = document.getElementById("cpf");
	let inputTelefone = document.getElementById("telefone");
	let inputEmail = document.getElementById("email");
	let inputSenha = document.getElementById("senha");
	let inputConfirmarSenha = document.getElementById("confirmarSenha");
	let inputCep = document.getElementById("cep");
	let inputLogradouro = document.getElementById("logradouro");
	let inputComplemento = document.getElementById("complemento");
	let inputBairro = document.getElementById("bairro");
	let inputCidade = document.getElementById("cidade");
	let inputUf = document.getElementById("uf");
	let inputNumero = document.getElementById("numero");
	let inputEnderecoFiscal = document.getElementById("enderecoFiscal");
	
	
	function preencherCampos(){
		get("http://localhost:3000/usuario").then(usuario => {
			
			enderecos = [];
			enderecosInseridos = [];
			enderecosFormatados = [];
			i = 0;
			idUsuario = 0;
			enderecosRemovidos = [];
			
			
			inputNome.value = usuario.nome;
			inputCpf.value = usuario.cpf;
			inputTelefone.value = usuario.telefone;
			inputEmail.value = usuario.email;
		
			idUsuario = usuario.id;
			enderecos = usuario.enderecos;
			i = usuario.enderecos.length;
			atualizaTabela();
		})
	}

	function buscarCep(){
		event.preventDefault()
			
		let url = `https://viacep.com.br/ws/${cep.value}/json/`;

		get(url).then(endereco => {
			inputLogradouro.value = endereco.logradouro;
			inputBairro.value = endereco.bairro;
			inputComplemento.value = endereco.complemento;
			inputCidade.value = endereco.localidade;
			inputUf.value = endereco.uf;
 		});
	}
	
	function editarUsuario(){
		let nome = inputNome.value;
		let cpf = inputCpf.value;
		let telefone = inputTelefone.value;
		let email = inputEmail.value;
		let senha = inputSenha.value;
		let confirmarSenha = inputConfirmarSenha.value;
		
		let erros = validar();
		
		if(erros.length > 0){
			exibirErros(erros);
			return;
		}
		
		let usuario = {
				nome: nome,
				cpf: cpf,
				telefone: telefone,
				email: email,
				senha: senha,
				enderecos: enderecosFormatados
		}
		
		removerEnderecos().then(() => {
			salvarEnderecos().then(() => {
				put("http://localhost:3000/usuario", usuario).then(() => {
					let texto = document.getElementById("erros");
					
					texto.innerHTML = "<h3> Usuário Editado Realizado com Sucesso </h3>";
					
					preencherCampos();
				})
			})
		});
		
	}
	
	function removerEnderecos(){
		
		return new Promise((resolve, reject) => {
			let promises = [];
			
			promises.push(new Promise((resolve, reject) => {
				enderecosRemovidos.forEach(id => {
					remove("http://localhost:3000/usuario/enderecos/"+id).then(() => {
						resolve();
					});
				});
				resolve();
			}));
			
			Promise.all(promises).then(() => resolve());
			
		});
		
	}
	
	function salvarEnderecos(){
		return new Promise((resolve, reject) => {
			let promises = [];
			
			
			promises.push(new Promise((resolve, reject) => {
				formatarEnderecos();
				enderecosFormatados.forEach(endereco => {
					post("http://localhost:3000/usuario/enderecos/" + idUsuario,endereco).then(() => {
						resolve();
					});
				});
				resolve();
			}));
			
			Promise.all(promises).then(() => resolve());
			
		});
	}
	
	function exibirErros(erros){
		let errosHtml = document.getElementById("erros");
		
		let html = ``;
		
		erros.forEach(erro => {
			html += `<p style="color: red;">${erro}</p>`
		})
		
		errosHtml.innerHTML = html;
	}
	
	function validar(){
		let nome = inputNome.value;
		let cpf = inputCpf.value;
		let telefone = inputTelefone.value;
		let email = inputEmail.value;
		let senha = inputSenha.value;
		let confirmarSenha = inputConfirmarSenha.value;
		
		let erros = [];
		
		if(senha != confirmarSenha){
			erros.push("As senhas devem ser iguais");
		}
		
		if(nome == ""){
			erros.push("O campo nome é obrigatório");
		}
		
		if(email == ""){
			erros.push("O campo email é obrigatório");
		}
		
		if(senha == ""){
			erros.push("O campo senha é obrigatório");
		}
		
		if(senha == ""){
			erros.push("O campo confirmar senha é obrigatório");
	
		}
		
		if(enderecosFormatados.length == 0 && enderecosInseridos.length == 0){
			erros.push("Deve se cadastrar no minimo um endereço.");
		}
		
		return erros;
	}
	
	function formatarEnderecos(){
		for(let i = 0; i < enderecosInseridos.length; i++){
			
			let fiscal = false;
			if(enderecosInseridos[i].fiscal == "Sim" || enderecosInseridos[i].fiscal){
				fiscal = true;
			}
			
			let endereco = {
				logradouro: enderecos[i].logradouro,
				cep: enderecos[i].cep,
				complemento: enderecos[i].complemento,
				bairro: enderecos[i].bairro,
				cidade: enderecos[i].cidade,
				uf: enderecos[i].uf,
				numero: enderecos[i].numero,
				fiscal: fiscal
			}
			
			enderecosFormatados.push(endereco);
		}
	}
	
	function addEndereco(){
		event.preventDefault()
		
		let fiscal = "";
		
		if(inputEnderecoFiscal.checked){
			fiscal = "Sim";
		}else{
			fiscal = "Não";
		}
		
		let endereco = {
			id: i,
			logradouro: inputLogradouro.value,
			cep: inputCep.value,
			complemento: inputComplemento.value,
			bairro: inputBairro.value,
			cidade: inputCidade.value,
			uf: inputUf.value,
			numero: inputNumero.value,
			fiscal: fiscal
		}
		
		enderecosInseridos.push(endereco);
		enderecos.push(endereco);
		i++;
		
		atualizaTabela();
		limparCamposEndereco();
	}
	
	function limparCamposEndereco(){
		inputLogradouro.value = "";
		inputCep.value = "";
		inputComplemento.value = "";
		inputBairro.value = "";
		inputCidade.value = "";
		inputUf.value = "";
		inputNumero.value = "";
		inputEnderecoFiscal.checked = false;
	}
	
	function limparCampos(){
		inputNome.value = "";
		inputCpf.value = "";
		inputTelefone.value = "";
		inputEmail.value = "";
		inputSenha.value = "";
		inputConfirmarSenha.value = "";
	}
	
	function atualizaTabela(){
		let tabela = document.getElementById('tabela');
		let html = ``;
		
		
		
		enderecos.forEach(endereco => {
			if(endereco.fiscal == true || endereco.fiscal == "Sim"){
				endereco.fiscal = "Sim";	
			} else {
				endereco.fiscal = "Não";
			}
			
			html += `<tr>
						<td> ${endereco.cep} </td>
						<td> ${endereco.logradouro} </td>
						<td> ${endereco.complemento} </td>
						<td> ${endereco.bairro} </td>
						<td> ${endereco.cidade} </td>
						<td> ${endereco.uf} </td>
						<td> ${endereco.numero} </td>
						<td> ${endereco.fiscal} </td>
						<td> <button class="click-btn btn btn-default" onclick="removerEndereco(${endereco.id})"><i class="fa fa-remove" aria-hidden="true"></i></button></td>
					</tr>`
		})
		
		tabela.innerHTML = html;
	}
	
	function removerEndereco(index){
		event.preventDefault();
		for(let i = 0; i < enderecos.length; i++){
			if(enderecos[i].id == index){
				enderecosRemovidos.push(index);
				let removido = enderecos.splice(i, 1);
				removido = enderecosInseridos.splice(i, 1);
				atualizaTabela();
				return;
			}
		}
	}
	
	function get(url) {
		return new Promise((resolve, reject) => {

			let xhr = new XMLHttpRequest();

			xhr.open('GET', url);

			xhr.onreadystatechange = () => {

				if (xhr.readyState == 4) {

					if (xhr.status == 200) {
						let resposta = JSON.parse(xhr.responseText);
						if(!resposta.erro){
							console.log(xhr.responseText)
							resolve(resposta);
						}else{
							document.getElementById("texto").textContent = "CEP não encontrado.";
						}

					} else {
						document.getElementById("texto").textContent = "CEP não encontrado.";
						reject(xhr.responseText);
					}
				}
			}

			xhr.send();
		});
	}
	
	function put(url, dados) {
		return new Promise((resolve, reject) => {

			let xhr = new XMLHttpRequest();
			xhr.open("PUT", url, true);
			xhr.setRequestHeader("Content-type", "application/json");
			xhr.onreadystatechange = () => {

				if (xhr.readyState == 4) {

					if (xhr.status == 200) {
						resolve();
					} else {
						reject(xhr.responseText);
					}
				}
			};

			xhr.send(JSON.stringify(dados));
		});
	}
	
	function post(url, dados) {
		return new Promise((resolve, reject) => {

			let xhr = new XMLHttpRequest();
			xhr.open("POST", url, true);
			xhr.setRequestHeader("Content-type", "application/json");
			xhr.onreadystatechange = () => {

				if (xhr.readyState == 4) {

					if (xhr.status == 200) {
						resolve();
					} else {
						reject(xhr.responseText);
					}
				}
			};

			xhr.send(JSON.stringify(dados));
		});
	}
	
	function remove(url) {
		return new Promise((resolve, reject) => {

			let xhr = new XMLHttpRequest();
			xhr.open("DELETE", url, true);
			xhr.setRequestHeader("Content-type", "application/json");
			xhr.onreadystatechange = () => {

				if (xhr.readyState == 4) {

					if (xhr.status == 200) {
						console.log("ué")
						resolve();
					} else {
						reject(xhr.responseText);
					}
				}
			};

			xhr.send();
		});
	}
	
</script>

</html>